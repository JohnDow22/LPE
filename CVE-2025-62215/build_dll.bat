@echo off
REM ============================================================
REM  CVE-2025-62215 LPE Exploit DLL - Build Script
REM  Requires: Visual Studio / MSVC Build Tools (cl.exe)
REM ============================================================

setlocal

set SRC=exploit_dll.cpp
set OUT=cve_2025_62215.dll
set OUT_DEBUG=cve_2025_62215_dbg.dll
set HAVOC_MODULE=..\..\..\..\HavocClient\commander\modules\lpe\bin

REM Check if cl.exe is available
where cl.exe >nul 2>&1
if %errorlevel% neq 0 (
    echo [!] cl.exe not found. Run from Developer Command Prompt or:
    echo     "C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools\Common7\Tools\VsDevCmd.bat"
    echo     "C:\Program Files\Microsoft Visual Studio\2022\Community\Common7\Tools\VsDevCmd.bat"
    exit /b 1
)

if "%1"=="debug" goto :build_debug
if "%1"=="release" goto :build_release
if "%1"=="both" goto :build_both
if "%1"=="clean" goto :clean
if "%1"=="install" goto :install

REM Default: release + install
goto :build_release

:build_release
echo [*] Building RELEASE DLL...
cl.exe /nologo /O2 /MD /LD /GS- %SRC% ^
    /link /OUT:%OUT% ^
    kernel32.lib advapi32.lib user32.lib
if %errorlevel% equ 0 (
    echo [+] Release build: %OUT%
    call :cleanup_obj
    call :install
) else (
    echo [!] Release build FAILED
    exit /b 1
)
goto :eof

:build_debug
echo [*] Building DEBUG DLL (OutputDebugString logging)...
cl.exe /nologo /Od /Zi /MDd /LD /D_DEBUG %SRC% ^
    /link /OUT:%OUT_DEBUG% /DEBUG ^
    kernel32.lib advapi32.lib user32.lib
if %errorlevel% equ 0 (
    echo [+] Debug build: %OUT_DEBUG%
    echo [*] Use DebugView to see [LPE] messages
    call :cleanup_obj
) else (
    echo [!] Debug build FAILED
    exit /b 1
)
goto :eof

:build_both
call :build_release
call :build_debug
goto :eof

:install
if exist %OUT% (
    if exist %HAVOC_MODULE% (
        copy /Y %OUT% %HAVOC_MODULE%\ >nul
        echo [+] Installed to Havoc module: %HAVOC_MODULE%\%OUT%
    ) else (
        echo [!] Havoc module bin dir not found: %HAVOC_MODULE%
        echo [*] Copy %OUT% to HavocClient\commander\modules\lpe\bin\ manually
    )
)
goto :eof

:clean
echo [*] Cleaning...
del /q *.obj *.exp *.lib *.pdb *.ilk 2>nul
del /q %OUT% %OUT_DEBUG% 2>nul
echo [+] Clean done
goto :eof

:cleanup_obj
del /q exploit_dll.obj exploit_dll.exp exploit_dll.lib 2>nul
goto :eof

endlocal
