/*
 * System Information Utility
 * Gathers information about the target system for exploit compatibility
 */

#include <windows.h>
#include <iostream>
#include <string>
#include <VersionHelpers.h>
#include <shellapi.h> // Add this include at the top with the others
#include <shlobj.h>   // <-- Add this line for IsUserAnAdmin

void PrintSystemInfo() {
    std::cout << "========================================" << std::endl;
    std::cout << "System Information" << std::endl;
    std::cout << "========================================" << std::endl;

    // OS Version
    DWORD major = 0, minor = 0, build = 0;
    // Use VersionHelpers and RtlGetVersion for accurate version info
    typedef LONG (WINAPI* RtlGetVersionPtr)(PRTL_OSVERSIONINFOEXW);
    HMODULE hMod = ::GetModuleHandleW(L"ntdll.dll");
    if (hMod) {
        RtlGetVersionPtr fxPtr = (RtlGetVersionPtr)::GetProcAddress(hMod, "RtlGetVersion");
        if (fxPtr != nullptr) {
            RTL_OSVERSIONINFOEXW osvi = { 0 };
            osvi.dwOSVersionInfoSize = sizeof(osvi);
            if (fxPtr(&osvi) == 0) {
                major = osvi.dwMajorVersion;
                minor = osvi.dwMinorVersion;
                build = osvi.dwBuildNumber;
                std::wcout << L"OS Version: " << major << L"." << minor << std::endl;
                std::wcout << L"Build Number: " << build << std::endl;
                if (major == 10 && minor == 0) {
                    std::cout << "OS: Windows 10 or Windows 11" << std::endl;
                }
            }
        }
    }

    // Architecture
    SYSTEM_INFO si;
    GetNativeSystemInfo(&si);
    std::cout << "Architecture: ";
    switch (si.wProcessorArchitecture) {
        case PROCESSOR_ARCHITECTURE_AMD64:
            std::cout << "x64" << std::endl;
            break;
        case PROCESSOR_ARCHITECTURE_INTEL:
            std::cout << "x86" << std::endl;
            break;
        case PROCESSOR_ARCHITECTURE_ARM64:
            std::cout << "ARM64" << std::endl;
            break;
        default:
            std::cout << "Unknown" << std::endl;
    }

    // Privilege check
    std::cout << "Current Privileges:" << std::endl;
    if (IsUserAnAdmin()) {
        std::cout << "  - Administrator: Yes" << std::endl;
    } else {
        std::cout << "  - Administrator: No" << std::endl;
    }

    // Memory info
    MEMORYSTATUSEX memInfo;
    memInfo.dwLength = sizeof(MEMORYSTATUSEX);
    if (GlobalMemoryStatusEx(&memInfo)) {
        std::cout << "Memory:" << std::endl;
        std::cout << "  - Total Physical: " 
                  << (memInfo.ullTotalPhys / (1024 * 1024)) << " MB" << std::endl;
        std::cout << "  - Available Physical: " 
                  << (memInfo.ullAvailPhys / (1024 * 1024)) << " MB" << std::endl;
    }

    std::cout << "========================================" << std::endl;
}

// Check if system is potentially vulnerable
bool CheckVulnerability() {
    DWORD major = 0, minor = 0;
    typedef LONG (WINAPI* RtlGetVersionPtr)(PRTL_OSVERSIONINFOEXW);
    HMODULE hMod = ::GetModuleHandleW(L"ntdll.dll");
    if (hMod) {
        RtlGetVersionPtr fxPtr = (RtlGetVersionPtr)::GetProcAddress(hMod, "RtlGetVersion");
        if (fxPtr != nullptr) {
            RTL_OSVERSIONINFOEXW osvi = { 0 };
            osvi.dwOSVersionInfoSize = sizeof(osvi);
            if (fxPtr(&osvi) == 0) {
                major = osvi.dwMajorVersion;
                minor = osvi.dwMinorVersion;
            }
        }
    }

    // CVE-2025-62215 affects Windows 10/11
    // This is a simplified check - actual check would verify build numbers
    if (major == 10) {
        std::cout << "[*] System appears to be potentially vulnerable" << std::endl;
        std::cout << "[*] Note: Actual vulnerability depends on patch level" << std::endl;
        return true;
    }

    std::cout << "[!] System may not be vulnerable to CVE-2025-62215" << std::endl;
    return false;
}

// Renamed entry point to avoid duplicate 'main' when building both files in one project.
// Call `LocalTestMain()` from another file or create a separate project if you want a standalone executable.
int LocalTestMain() {
    PrintSystemInfo();
    std::cout << std::endl;
    CheckVulnerability();
    return 0;
}
